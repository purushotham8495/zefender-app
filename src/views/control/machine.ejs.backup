<%- include('../partials/header') %>

    <div class="bg-gray-800 p-4 mb-4 rounded text-xs font-mono overflow-auto max-h-64">
        <strong>DEBUG DATA:</strong>
        <pre><%= JSON.stringify(machine, null, 2) %></pre>
    </div>
    <!-- Main Grid Layout -->
    <div x-data="machineCtrl" class="min-h-screen bg-[#0f172a] text-slate-200 font-sans -m-6 p-6">
        <!-- Top Navigation Bar -->
        <div class="flex justify-between items-center mb-8">
            <a href="/machines" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span class="font-medium text-sm">Back to Machines</span>
            </a>

            <div class="flex items-center gap-4">
                <!-- Live Status Indicator -->
                <div class="flex items-center gap-2 bg-[#1e293b] px-3 py-1.5 rounded-full border border-slate-700/50">
                    <template x-if="connected">
                        <span
                            class="flex items-center gap-2 text-[10px] font-bold text-emerald-400 uppercase tracking-widest">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Live Link Active
                        </span>
                    </template>
                    <template x-if="!connected">
                        <span
                            class="flex items-center gap-2 text-[10px] font-bold text-red-400 uppercase tracking-widest">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Disconnected
                        </span>
                    </template>
                </div>

                <button @click="openConfigModal()"
                    class="p-2 bg-[#1e293b] rounded-full text-slate-400 hover:text-white hover:bg-slate-700 transition-colors border border-slate-700/50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <!-- Reconnect WiFi Button -->
                <button @click="reconnectWifi()" title="Reconnect WiFi"
                    class="p-2 bg-[#1e293b] rounded-full text-blue-400 hover:text-blue-300 hover:bg-slate-700 transition-colors border border-slate-700/50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Status & Emergency -->
            <div class="space-y-6">
                <!-- Machine Identity Card -->
                <div
                    class="bg-[#1e293b] rounded-2xl border border-slate-700/50 p-8 flex flex-col items-center justify-center relative overflow-hidden shadow-lg h-[340px]">
                    <div class="text-center z-10">
                        <h2 class="text-2xl font-bold text-white mb-1">
                            <%= machine.machine_name %>
                        </h2>
                        <p class="text-slate-500 font-mono text-xs tracking-widest uppercase">
                            <%= machine.machine_id %>
                        </p>
                    </div>

                    <!-- Circular Status/Timer -->
                    <div class="relative mt-8 mb-4">
                        <!-- Outer Ring -->
                        <div class="w-40 h-40 rounded-full border-4 border-slate-800"></div>
                        <!-- Active Ring (Simulated for now) -->
                        <div class="absolute top-0 left-0 w-40 h-40 rounded-full border-4 border-indigo-500 border-t-transparent border-r-transparent rotate-45"
                            x-show="runningSequence || connected"></div>

                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-4xl font-bold text-white"
                                x-text="runningSequence &#8377;'Running' : '0s'">0s</span>
                            <span class="text-xs text-slate-500 mt-1" x-show="runningSequence">SEQUENCE ACTIVE</span>
                            <span class="text-xs text-slate-500 mt-1"
                                x-show="!runningSequence && connected">READY</span>
                            <span class="text-xs text-red-500 mt-1" x-show="!connected">OFFLINE</span>
                        </div>
                    </div>

                    <div class="flex gap-2 text-xs text-slate-500 font-mono mt-4">
                        <span x-text="networkInfo?.ssid || 'No WiFi'"></span>
                        <span x-show="networkInfo?.rssi" x-text="'• ' + networkInfo.rssi + ' dBm'"></span>
                    </div>
                </div>

                <!-- Emergency Stop -->
                <button @click="emergencyStop()"
                    class="w-full bg-red-500 hover:bg-red-600 active:bg-red-700 text-white rounded-2xl p-6 flex items-center justify-between shadow-[0_0_20px_rgba(239,68,68,0.3)] transition-all group overflow-hidden relative">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
                    </div>
                    <div class="flex flex-col items-start z-10">
                        <span class="text-lg font-bold">Emergency Stop</span>
                        <span class="text-red-200 text-xs mt-1">Halt all operations immediately</span>
                    </div>
                    <div
                        class="bg-red-600 p-3 rounded-full border border-red-400 z-10 group-active:scale-90 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                    </div>
                </button>
            </div>

            <!-- Right Column: Controls -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Sequence Control -->
                <div class="bg-[#1e293b] rounded-2xl border border-slate-700/50 p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Sequence Control
                        </h3>
                        <button @click="openSequenceModal()"
                            class="text-xs font-bold text-indigo-400 hover:text-indigo-300 uppercase tracking-wider">Edit
                            Sequences</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Sequence Card (Simulated as one for now, but looping existing mock) -->
                        <template x-for="(seq, index) in sequences" :key="index">
                            <div
                                class="bg-[#0f172a]/50 rounded-xl p-4 border border-slate-700/50 hover:border-slate-600 transition-colors flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-slate-200"
                                        x-text="seq.description || 'Step ' + seq.step_index"></h4>
                                    <div class="flex items-center gap-4 mt-2">
                                        <span class="text-xs text-slate-500"
                                            x-text="(seq.duration_ms / 1000) + 's Duration'"></span>
                                        <span
                                            class="text-xs px-2 py-0.5 rounded bg-slate-800 text-slate-400 border border-slate-700"
                                            x-text="seq.action"></span>
                                    </div>
                                </div>
                                <!-- Assuming execute specific sequence logic, but controller only supports 'runSequence' which runs ALL. 
                                 For now, the 'Start' button will trigger the full routine as per backend logic. 
                                 Ideally, we should group sequences into 'Routines' but current DB model is simple. 
                                 I'll make the button trigger the full sequence for now.
                            -->
                            </div>
                        </template>
                        <% if(machine.sequences.length===0) { %>
                            <div class="col-span-2 text-center p-4 text-slate-500 text-sm">No sequences defined.</div>
                            <% } %>

                                <!-- General Run Button if sequences exist -->
                                <template x-if="sequences.length > 0">
                                    <div
                                        class="col-span-1 md:col-span-2 bg-[#0f172a]/50 rounded-xl p-4 border border-slate-700/50 flex justify-between items-center">
                                        <div>
                                            <h4 class="font-bold text-white">Main Routine</h4>
                                            <p class="text-xs text-slate-500 mt-1"><span
                                                    x-text="sequences.length"></span> Steps configured</p>
                                        </div>
                                        <button @click="runSequence()" :disabled="runningSequence || !connected"
                                            class="bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-bold text-sm shadow-[0_0_15px_rgba(99,102,241,0.3)] transition-all">
                                            <span x-text="runningSequence &#8377;'Running...' : 'Start'"></span>
                                        </button>
                                    </div>
                                </template>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-[#1e293b] rounded-2xl border border-slate-700/50 p-6 shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0-2.08-.402-2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            Recent Transactions
                        </h3>
                    </div>
                    <div class="space-y-4">
                        <template x-for="tx in transactions" :key="tx.event_time">
                            <div
                                class="flex items-center justify-between p-4 bg-[#0f172a] rounded-xl border border-slate-700/50">
                                <div>
                                    <p class="text-white font-bold text-sm">?<span
                                            x-text="parseFloat(tx.amount).toFixed(2)"></span></p>
                                    <p class="text-xs text-slate-500 mt-1"
                                        x-text="new Date(tx.event_time).toLocaleString()"></p>
                                </div>
                                <div
                                    class="bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide border border-emerald-500/20">
                                    Captured
                                </div>
                            </div>
                        </template>
                        <template x-if="transactions.length === 0">
                            <p class="text-slate-500 text-sm italic text-center py-4">No recent transactions</p>
                        </template>
                    </div>
                </div>

                <!-- GPIO Control Matrix -->
                <div class="bg-[#1e293b] rounded-2xl border border-slate-700/50 p-6 shadow-sm min-h-[400px]">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z">
                                </path>
                            </svg>
                            GPIO Control Matrix
                        </h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="gpio in gpios" :key="gpio.pin_number">
                            <div
                                class="bg-[#0f172a] rounded-xl p-5 border border-slate-700/50 relative overflow-hidden group">
                                <!-- Status Indicator Dot -->
                                <div class="absolute top-4 right-4 w-2 h-2 rounded-full shadow-[0_0_5px_currentColor]"
                                    :class="(gpio.is_active_low &#8377;!gpio.is_active : gpio.is_active) &#8377;'bg-emerald-400 text-emerald-400' : 'bg-slate-600 text-slate-600'">
                                </div>

                                <div class="mb-6">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors"
                                        :class="(gpio.is_active_low &#8377;!gpio.is_active : gpio.is_active) &#8377;'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-500'">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="font-bold text-white text-lg"
                                        x-text="gpio.label || 'GPIO ' + gpio.pin_number">Heating Element</h4>
                                    <p class="text-xs text-slate-500 font-mono mt-1">PIN <span
                                            x-text="gpio.pin_number"></span> • <span
                                            x-text="(gpio.is_active_low &#8377;!gpio.is_active : gpio.is_active) &#8377;'ACTIVE' : 'IDLE'"></span>
                                    </p>
                                </div>

                                <button @click="toggleGPIO(gpio.pin_number)" :disabled="runningSequence || !connected"
                                    class="w-full py-2.5 rounded-lg font-medium text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    :class="(gpio.is_active_low &#8377;!gpio.is_active : gpio.is_active) 
                                    &#8377;'bg-slate-800 text-red-400 hover:bg-slate-700 hover:text-red-300' 
                                    : 'bg-[#1e293b] border border-slate-600 text-slate-300 hover:bg-indigo-600 hover:text-white hover:border-indigo-500'">
                                    <span
                                        x-text="(gpio.is_active_low &#8377;!gpio.is_active : gpio.is_active) &#8377;'Turn Off' : 'Turn On'"></span>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals (Re-using existing logic with updated styling) -->
        <!-- GPIO Configuration Modal -->
        <div x-show="gpioModalOpen"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm" x-cloak>
            <div @click.away="gpioModalOpen = false"
                class="bg-[#1e293b] rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-[#0f172a]">
                    <h3 class="text-lg font-bold text-white">Configure Pins</h3>
                    <button @click="gpioModalOpen = false" class="text-slate-400 hover:text-white"><svg class="w-5 h-5"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg></button>
                </div>
                <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <template x-for="(g, index) in editedGpios" :key="index">
                        <div class="flex gap-3 bg-[#0f172a] p-3 rounded-lg border border-slate-700">
                            <div class="flex-1">
                                <label class="text-[10px] text-slate-500 uppercase font-bold">Pin</label>
                                <input type="number" x-model.number="g.pin_number"
                                    class="w-full bg-[#1e293b] border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-indigo-500 outline-none">
                            </div>
                            <div class="flex-[2]">
                                <label class="text-[10px] text-slate-500 uppercase font-bold">Label</label>
                                <input type="text" x-model="g.label"
                                    class="w-full bg-[#1e293b] border border-slate-600 rounded px-2 py-1 text-white text-sm focus:border-indigo-500 outline-none">
                            </div>
                            <button @click="editedGpios.splice(index, 1)"
                                class="self-end p-2 text-red-400 hover:text-red-300"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg></button>
                        </div>
                    </template>
                    <button @click="editedGpios.push({ pin_number: '', label: '' })"
                        class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-sm font-medium transition-colors">Add
                        Pin</button>
                </div>
                <div class="px-6 py-4 bg-[#0f172a] flex gap-3">
                    <button @click="gpioModalOpen = false"
                        class="flex-1 py-2 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button @click="saveGPIOConfig()"
                        class="flex-[2] py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium shadow-lg shadow-indigo-500/20">Save
                        Changes</button>
                </div>
            </div>
        </div>

        <!-- Sequence Editor Modal -->
        <div x-show="sequenceModalOpen"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm" x-cloak>
            <div @click.away="sequenceModalOpen = false"
                class="bg-[#1e293b] rounded-2xl shadow-2xl border border-slate-700 w-full max-w-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-[#0f172a]">
                    <h3 class="text-lg font-bold text-white">Edit Sequences</h3>
                    <button @click="sequenceModalOpen = false" class="text-slate-400 hover:text-white"><svg
                            class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg></button>
                </div>
                <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <template x-for="(s, index) in editedSequences" :key="index">
                        <div class="bg-[#0f172a] p-4 rounded-xl border border-slate-700 space-y-3">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="bg-indigo-600 text-white w-5 h-5 rounded flex items-center justify-center text-xs font-bold"
                                        x-text="index + 1"></span>
                                    <input type="text" x-model="s.description" placeholder="Description"
                                        class="bg-transparent border-none outline-none text-white font-medium text-sm placeholder-slate-600">
                                </div>
                                <button @click="editedSequences.splice(index, 1)"
                                    class="text-red-400 hover:text-red-300"><svg class="w-4 h-4" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg></button>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase font-bold">Pin</label>
                                    <select x-model.number="s.pin_number"
                                        class="w-full bg-[#1e293b] border border-slate-600 rounded px-2 py-1 text-white text-sm outline-none">
                                        <template x-for="g in gpios" :key="g.pin_number">
                                            <option :value="g.pin_number"
                                                x-text="'Pin ' + g.pin_number + ' (' + g.label + ')'"></option>
                                        </template>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase font-bold">Action</label>
                                    <select x-model="s.action"
                                        class="w-full bg-[#1e293b] border border-slate-600 rounded px-2 py-1 text-white text-sm outline-none">
                                        <option value="ON">ON</option>
                                        <option value="OFF">OFF</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase font-bold">Duration (ms)</label>
                                    <input type="number" x-model.number="s.duration_ms" step="500"
                                        class="w-full bg-[#1e293b] border border-slate-600 rounded px-2 py-1 text-white text-sm outline-none">
                                </div>
                            </div>
                        </div>
                    </template>
                    <button
                        @click="editedSequences.push({ pin_number: gpios[0]?.pin_number || 16, action: 'ON', duration_ms: 1000, step_index: editedSequences.length + 1 })"
                        class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg text-sm font-medium transition-colors">Add
                        Step</button>
                </div>
                <div class="px-6 py-4 bg-[#0f172a] flex gap-3">
                    <button @click="sequenceModalOpen = false"
                        class="flex-1 py-2 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button @click="saveSequenceConfig()"
                        class="flex-[2] py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium shadow-lg shadow-indigo-500/20">Save
                        Sequence</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('machineCtrl', () => ({
                machine_id: <%- JSON.stringify(machine.machine_id || '') %>,
                machine_name: <%- JSON.stringify(machine.machine_name || '') %>,
                connected: <%- !!machine.is_connected %>,
                runningSequence: <%- !!machine.is_running_sequence %>,
                networkInfo: <%- typeof machine.network_info === 'string' ? machine.network_info : JSON.stringify(machine.network_info || {}) %>,
                gpios: <%- JSON.stringify(machine.gpios || []) %>,
                sequences: <%- JSON.stringify(machine.sequences || []) %>,
                transactions: <%- JSON.stringify(recentTransactions || []) %>, lastHeartbeat: new Date().toLocaleTimeString(),

                gpioModalOpen: false,
                editedGpios: [],
                sequenceModalOpen: false,
                editedSequences: [],
                socket: null,

                init() {
                    console.log('Alpine Component Initialized', this.machine_id);
                    const socket = io();
                    this.socket = socket;

                    socket.emit('register', JSON.stringify({ machine_id: 'web_client_' + Date.now() }));

                    socket.on('machine_update', (data) => {
                        if (data.machine_id === this.machine_id) {
                            if (data.is_connected !== undefined) this.connected = data.is_connected; if (data.last_heartbeat) this.lastHeartbeat = new Date(data.last_heartbeat).toLocaleTimeString();

                            if (data.is_running_sequence === true && this.runningSequence === false) {
                                this.showToast('Sanitization Process Started');
                            }

                            if (data.new_transaction) {
                                this.transactions.unshift(data.new_transaction);
                                if (this.transactions.length > 5) this.transactions.pop();
                            }

                            if (data.is_running_sequence !== undefined) this.runningSequence = data.is_running_sequence;
                            if (data.network) this.networkInfo = data.network;

                            if (data.states) {
                                this.gpios.forEach(g => {
                                    const val = data.states[g.pin_number];
                                    if (val !== undefined) {
                                        g.is_active = (val === true || val === 1 || val === '1');
                                    }
                                });
                            }
                        }
                    });
                },

                showToast(message) {
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 z-[100] animate-bounce';
                    toast.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="font-bold">${message}</span>`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                },

                async toggleGPIO(pin) { console.log('Toggle GPIO request:', pin, 'Conn:', this.connected, 'Running:', this.runningSequence);
                    if (!this.connected || this.runningSequence) return;
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/toggle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' },
                            body: JSON.stringify({ pin })
                        });
                        const result = await response.json();
                        if (!result.success) alert('Command failed');
                    } catch (err) { console.error(err); }
                },

                async runSequence() {
                    if (!this.connected || this.runningSequence) return;
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/sequence`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' }
                        });
                        const result = await response.json();
                        if (result.success) this.runningSequence = true;
                    } catch (err) { console.error(err); }
                },

                async emergencyStop() {
                    if (!confirm('EMERGENCY STOP: Are you sure?')) return;
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/emergency-stop`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' }
                        });
                        const result = await response.json();
                        if (result.success) {
                            this.runningSequence = false;
                            alert('Emergency Stop Command Sent');
                        }
                    } catch (err) { console.error(err); }
                },

                async reconnectWifi() {
                    if (!confirm('Request WiFi Reconnection?')) return;
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/reconnect-wifi`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' }
                        });
                        const result = await response.json();
                        if (result.success) alert('Reconnection command sent');
                    } catch (err) { console.error(err); }
                },

                openConfigModal() {
                    this.editedGpios = JSON.parse(JSON.stringify(this.gpios));
                    this.gpioModalOpen = true;
                },

                async saveGPIOConfig() {
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/config`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' },
                            body: JSON.stringify({ gpios: this.editedGpios })
                        });
                        const result = await response.json();
                        // Reload to reflect changes
                        location.reload();
                    } catch (err) { console.error(err); }
                },

                openSequenceModal() {
                    this.editedSequences = JSON.parse(JSON.stringify(this.sequences));
                    this.sequenceModalOpen = true;
                },

                async saveSequenceConfig() {
                    try {
                        const response = await fetch(`/machines/control/${this.machine_id}/sequence/update`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= csrfToken %>' },
                            body: JSON.stringify({ sequences: this.editedSequences })
                        });
                        const result = await response.json();
                        if (result.success) location.reload();
                    } catch (err) { console.error(err); }
                }
            }));
        });
    </script>

    <%- include('../partials/footer') %>
