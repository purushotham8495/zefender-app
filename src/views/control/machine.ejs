<%- include('../partials/header') %>
    <style>
        @keyframes progress-indefinite {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-progress-indefinite {
            animation: progress-indefinite 1.5s infinite linear;
            width: 50%;
        }
    </style>

    <div class="bg-gray-800 p-4 mb-4 rounded text-xs font-mono overflow-auto max-h-64 hidden">
        <strong>DEBUG DATA:</strong>
        <pre><%= JSON.stringify(machine, null, 2) %></pre>
    </div>
    <!-- Main Grid Layout -->
    <div x-data="machineCtrl"
        class="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-sans p-4 sm:p-6 lg:p-8">
        <!-- Top Navigation Bar -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 sm:mb-8">
            <a href="/machines"
                class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors group">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 transition-transform group-hover:-translate-x-1" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span class="font-medium text-xs sm:text-sm">Back to Machines</span>
            </a>

            <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                <!-- Live Status Indicator -->
                <div x-cloak
                    :class="connected ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-red-500/10 border-red-500/30'"
                    class="flex items-center gap-2 px-3 py-1.5 sm:py-1.5 rounded-full border transition-all shadow-sm flex-shrink-0">
                    <template x-if="connected">
                        <span
                            class="flex items-center gap-2 text-[9px] sm:text-[10px] font-bold text-emerald-400 uppercase tracking-widest whitespace-nowrap">
                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            ONLINE
                        </span>
                    </template>
                    <template x-if="!connected">
                        <span
                            class="flex items-center gap-2 text-[9px] sm:text-[10px] font-bold text-red-400 uppercase tracking-widest whitespace-nowrap">
                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            OFFLINE
                        </span>
                    </template>
                </div>

                <% if(user.role==='admin' ) { %>
                    <button @click="openConfigModal()"
                        class="px-3 sm:px-4 py-1.5 sm:py-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 hover:text-indigo-300 rounded-xl border border-indigo-500/20 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest transition-all shadow-sm flex-shrink-0">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Hardware Config</span>
                        <span class="sm:hidden">Config</span>
                    </button>
                    <% } %>

                        <button @click="reconnectWifi()"
                            class="px-3 sm:px-4 py-1.5 sm:py-2 bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 hover:text-amber-300 rounded-xl border border-amber-500/20 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest transition-all shadow-sm flex-shrink-0">
                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0">
                                </path>
                            </svg>
                            <span class="hidden sm:inline">WiFi Reconnect</span>
                            <span class="sm:hidden">WiFi</span>
                        </button>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Left Column: Status & Emergency -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Machine Identity Card -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 p-6 sm:p-8 flex flex-col items-center justify-center relative overflow-hidden shadow-xl sm:min-h-[380px]">

                    <% if(user.role==='admin' ) { %>
                        <!-- Settings Gear -->
                        <button @click="otaModalOpen = true"
                            class="absolute top-4 right-4 flex items-center gap-2 px-3 py-1.5 bg-slate-50 dark:bg-slate-800/80 rounded-xl text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all z-20 border border-slate-200 dark:border-slate-700/50 group shadow-sm">
                            <span class="text-[9px] font-black uppercase tracking-widest hidden sm:inline">OTA
                                Update</span>
                            <svg class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <% } %>
                            <div class="text-center z-10 w-full px-16 relative">
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-1 truncate"
                                    title="<%= machine.machine_name %>">
                                    <%= machine.machine_name %>
                                </h2>
                                <p class="text-slate-400 dark:text-slate-500 font-mono text-xs tracking-widest uppercase truncate"
                                    title="<%= machine.machine_id %>">
                                    <%= machine.machine_id %>
                                </p>
                            </div>

                            <!-- Improved Circular Status/Timer -->
                            <div class="relative mt-8 mb-6 group">
                                <!-- Background Glow -->
                                <div
                                    class="absolute inset-0 bg-indigo-500/10 blur-3xl rounded-full scale-150 active:scale-125 transition-transform duration-1000">
                                </div>

                                <!-- SVG Progress Ring -->
                                <svg class="w-40 h-40 sm:w-48 sm:h-48 -rotate-90 transform relative z-10">
                                    <!-- Background Track -->
                                    <circle cx="50%" cy="50%" r="44%" stroke="currentColor" stroke-width="6"
                                        fill="transparent" class="text-slate-100 dark:text-slate-800" />

                                    <!-- Progress Bar -->
                                    <circle cx="50%" cy="50%" r="44%" stroke="currentColor" stroke-width="8"
                                        fill="transparent" stroke-dasharray="276"
                                        :stroke-dashoffset="276 - (runningSequence ? ((currentStepIndex || 0) / (sequences.length || 1) * 276) : (connected ? 276 * 0.2 : 0))"
                                        stroke-linecap="round" :class="{
                                    'text-indigo-500 transition-all duration-700 ease-out': runningSequence,
                                    'text-emerald-500/50 transition-all': !runningSequence && connected,
                                    'text-slate-200 dark:text-slate-800 transition-all': !connected
                                }" />

                                    <!-- Scanning/Pulse Effect (Idle/Connected) -->
                                    <circle x-show="!runningSequence && connected" cx="50%" cy="50%" r="44%"
                                        stroke="currentColor" stroke-width="2" fill="transparent"
                                        class="text-emerald-500/40 animate-pulse" stroke-dasharray="20 100" />
                                </svg>

                                <!-- Central Content -->
                                <div
                                    class="absolute inset-0 flex flex-col items-center justify-center z-20 text-center px-6">
                                    <!-- Running State -->
                                    <template x-if="runningSequence">
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-[10px] text-indigo-500 dark:text-indigo-400 font-black tracking-[0.2em] uppercase mb-1">Process</span>
                                            <span
                                                class="text-4xl font-black text-slate-800 dark:text-white leading-none"
                                                x-text="currentStepIndex ? '#' + currentStepIndex : '..'"></span>
                                            <span
                                                class="text-[9px] text-slate-500 dark:text-slate-400 font-bold mt-2 uppercase tracking-widest bg-slate-100 dark:bg-slate-800/50 px-2 py-0.5 rounded backdrop-blur-sm truncate max-w-[120px]"
                                                x-text="currentStepDescription || 'Executing'"></span>
                                        </div>
                                    </template>

                                    <!-- Ready State -->
                                    <template x-if="!runningSequence && connected">
                                        <div class="flex flex-col items-center">
                                            <div
                                                class="w-12 h-12 bg-emerald-500/10 rounded-full flex items-center justify-center mb-2">
                                                <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <span
                                                class="text-xs font-black text-emerald-400 tracking-[0.2em] uppercase">Ready</span>
                                            <span class="text-[8px] text-slate-500 font-mono mt-1">SYSTEM
                                                ARMED</span>
                                        </div>
                                    </template>

                                    <!-- Offline State -->
                                    <template x-if="!connected">
                                        <div class="flex flex-col items-center">
                                            <div
                                                class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mb-2">
                                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728">
                                                    </path>
                                                </svg>
                                            </div>
                                            <span
                                                class="text-xs font-black text-red-500 tracking-[0.2em] uppercase">Offline</span>
                                            <span class="text-[8px] text-slate-600 font-mono mt-1">LINK
                                                DROPPED</span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div
                                class="flex flex-wrap items-center gap-y-2 gap-x-3 justify-center text-[10px] text-slate-500 font-mono mt-6 w-full">
                                <div class="flex items-center gap-2 justify-center w-full px-2">
                                    <!-- Bullet & SSID -->
                                    <span x-show="networkInfo?.ssid" class="truncate max-w-[120px]"
                                        x-text="networkInfo.ssid"></span>
                                    <span x-show="!networkInfo?.ssid">No WiFi</span>

                                    <span x-show="networkInfo?.rssi"
                                        x-html="'&bull; ' + networkInfo.rssi + ' dBm'"></span>
                                </div>
                                <div x-show="networkInfo?.ip"
                                    class="text-indigo-600 dark:text-indigo-400 font-bold px-2 py-0.5 bg-indigo-500/10 rounded"
                                    x-text="networkInfo.ip">
                                </div>
                                <div x-show="pingMs > 0" class="text-[10px] text-slate-400 font-mono"
                                    x-text="'Ping: ' + pingMs + ' ms'"></div>
                                <div class="w-full text-center text-[9px] text-slate-500 dark:text-slate-600 font-mono mt-1"
                                    x-text="'Heartbeat: ' + lastHeartbeat">
                                </div>
                            </div>
                </div>

                <!-- Emergency Stop -->
                <button @click="emergencyStop()"
                    class="w-full bg-white dark:bg-slate-900 border border-red-500/30 hover:bg-red-500 active:bg-red-600 text-slate-800 dark:text-white rounded-2xl p-6 flex items-center justify-between shadow-lg transition-all group overflow-hidden relative mb-4">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-transparent via-red-500/5 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
                    </div>
                    <div class="flex flex-col items-start z-10">
                        <span class="text-sm font-black text-red-500 uppercase tracking-widest">Emergency Stop</span>
                        <span class="text-slate-400 dark:text-slate-500 text-[10px] mt-1 font-bold">HALT ALL
                            OPERATIONS</span>
                    </div>
                    <div
                        class="bg-red-500/10 p-3 rounded-full border border-red-500/20 z-10 group-hover:bg-white group-hover:text-red-500 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                    </div>
                </button>

                <!-- Recent Transactions (Moved to Left Column) -->
                <div
                    class="bg-white dark:bg-[#1e293b] rounded-2xl border border-slate-300 dark:border-slate-700/50 p-6 shadow-xl mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0-2.08-.402-2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            Live Transactions
                        </h3>
                        <div class="flex gap-2">
                            <button @click="showQRModal = true"
                                class="text-[9px] font-black text-indigo-500 bg-indigo-500/10 hover:bg-indigo-500/20 px-3 py-1.5 rounded-lg border border-indigo-500/20 uppercase tracking-widest transition-all">
                                Payment QR
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="tx in transactions.slice(0, 3)" :key="tx.event_time">
                            <div
                                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-[#0f172a]/50 rounded-xl border border-slate-300 dark:border-slate-700/30 hover:border-emerald-500/30 transition-all group">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition-all">
                                        <span class="text-xs font-bold">₹</span>
                                    </div>
                                    <div>
                                        <p class="text-slate-800 dark:text-white font-black text-sm leading-none"
                                            x-text="'₹' + parseFloat(tx.amount).toFixed(2)"></p>
                                        <p class="text-[9px] text-slate-500 mt-1 font-mono"
                                            x-text="new Date(tx.event_time).toLocaleTimeString()"></p>
                                    </div>
                                </div>
                                <div
                                    class="bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-widest border border-emerald-500/20">
                                    OK
                                </div>
                            </div>
                        </template>
                        <template x-if="transactions.length === 0">
                            <div class="text-center py-6">
                                <div
                                    class="w-10 h-10 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">No Activity
                                </p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls -->
            <div class="lg:col-span-8 space-y-6">

                <!-- Sequence Control -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Sequence Control
                        </h3>
                        <% if(user.role==='admin' ) { %>
                            <button @click="openSequenceModal()"
                                class="text-xs font-bold text-indigo-400 hover:text-indigo-300 uppercase tracking-wider">Edit
                                Cloud steps</button>
                            <% } %>
                    </div>

                    <div class="space-y-6">
                        <!-- WEBSITE SEQUENCE CARD -->
                        <div
                            class="bg-indigo-500/5 rounded-2xl p-6 border border-slate-300 dark:border-indigo-500/20 relative flex flex-col gap-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Website Sequence
                                        </h4>
                                        <template x-if="primary_sequence_id === 'DB_DEFAULT'">
                                            <span
                                                class="bg-indigo-500 text-white text-[9px] px-2 py-0.5 rounded-full uppercase tracking-widest font-black animate-pulse shadow-lg shadow-indigo-500/20">Primary</span>
                                        </template>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Full control of steps via the cloud dashboard
                                    </p>
                                </div>
                                <div class="hidden sm:block">
                                    <div class="p-2 bg-indigo-500/10 rounded-xl">
                                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                            </path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Horizontal Steps Timeline -->
                            <div class="relative">
                                <template x-if="sequences.length > 0">
                                    <div class="flex gap-3 overflow-x-auto pb-4 custom-scrollbar">
                                        <template x-for="step in sequences" :key="step.step_index">
                                            <div class="flex-shrink-0 w-32 rounded-xl p-3 shadow-sm transition-all cursor-default group/step"
                                                :class="step.action === 'ON' ? 'bg-emerald-500/10 border border-emerald-500/30 hover:border-emerald-500/50' : (step.action === 'OFF' ? 'bg-red-500/10 border border-red-500/30 hover:border-red-500/50' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:border-indigo-500/50')">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-[10px] font-black"
                                                        :class="step.action === 'ON' ? 'text-emerald-500' : (step.action === 'OFF' ? 'text-red-500' : 'text-indigo-500')"
                                                        x-text="'STEP '+step.step_index"></span>
                                                    <div class="w-1.5 h-1.5 rounded-full transition-colors"
                                                        :class="step.action === 'ON' ? 'bg-emerald-500' : (step.action === 'OFF' ? 'bg-red-500' : 'bg-slate-400 group-hover/step:bg-indigo-500')">
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-1">
                                                    <span class="text-xs font-black uppercase tracking-tight"
                                                        :class="step.action === 'ON' ? 'text-emerald-600 dark:text-emerald-400' : (step.action === 'OFF' ? 'text-red-600 dark:text-red-400' : 'text-slate-900 dark:text-white')"
                                                        x-text="step.action"></span>
                                                    <span class="text-[10px] text-slate-500 font-bold"
                                                        x-text="step.duration_ms + 'ms'"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="sequences.length === 0">
                                    <div
                                        class="py-4 text-center border border-dashed border-slate-300 dark:border-slate-700 rounded-xl">
                                        <p class="text-xs text-slate-400 italic">No cloud steps configured yet...</p>
                                    </div>
                                </template>
                            </div>

                            <div
                                class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 border-t border-slate-200 dark:border-indigo-500/10 pt-5 mt-auto">
                                <% if(user.role==='admin' ) { %>
                                    <button @click="setPrimarySequence('DB_DEFAULT')"
                                        :disabled="primary_sequence_id === 'DB_DEFAULT'"
                                        class="flex-1 text-[10px] font-black uppercase tracking-widest px-4 py-3 rounded-xl border transition-all active:scale-95"
                                        :class="primary_sequence_id === 'DB_DEFAULT' ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20 opacity-50' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border-transparent hover:bg-slate-200 dark:hover:bg-slate-700'">
                                        <span
                                            x-text="primary_sequence_id === 'DB_DEFAULT' ? '✓ Primary Active' : 'Set as Primary'"></span>
                                    </button>
                                    <% } %>
                                        <button @click="runSequence('DB_DEFAULT')"
                                            :disabled="runningSequence || !connected"
                                            class="flex-[1.5] bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-indigo-600/20 transition-all active:scale-95 disabled:opacity-50">
                                            Trigger Cloud Sequence
                                        </button>
                            </div>
                        </div>

                        <!-- FIRMWARE SEQUENCE CARD -->
                        <div
                            class="bg-amber-500/5 rounded-2xl p-6 border border-slate-300 dark:border-amber-500/20 flex flex-col gap-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Firmware Sequence
                                        </h4>
                                        <template x-if="primary_sequence_id === 'INTERNAL_CLEAN'">
                                            <span
                                                class="bg-amber-500 text-white text-[9px] px-2 py-0.5 rounded-full uppercase tracking-widest font-black animate-pulse shadow-lg shadow-amber-500/20">Primary</span>
                                        </template>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Triggers logic hardcoded inside the ESP32 C++
                                        code</p>
                                </div>
                                <div class="hidden sm:block">
                                    <div class="p-2 bg-amber-500/10 rounded-xl">
                                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z">
                                            </path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 border-t border-slate-200 dark:border-amber-500/10 pt-5 mt-auto">
                                <% if(user.role==='admin' ) { %>
                                    <button @click="setPrimarySequence('INTERNAL_CLEAN')"
                                        :disabled="primary_sequence_id === 'INTERNAL_CLEAN'"
                                        class="flex-1 text-[10px] font-black uppercase tracking-widest px-4 py-3 rounded-xl border transition-all active:scale-95"
                                        :class="primary_sequence_id === 'INTERNAL_CLEAN' ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20 opacity-50' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border-transparent hover:bg-slate-200 dark:hover:bg-slate-700'">
                                        <span
                                            x-text="primary_sequence_id === 'INTERNAL_CLEAN' ? '✓ Primary Active' : 'Set as Primary'"></span>
                                    </button>
                                    <% } %>
                                        <button @click="runSequence('INTERNAL_CLEAN')"
                                            :disabled="runningSequence || !connected"
                                            class="flex-[1.5] bg-slate-900 dark:bg-slate-800 hover:bg-slate-800 dark:hover:bg-slate-750 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-xl transition-all border border-slate-700 dark:border-slate-700 active:scale-95 disabled:opacity-50">
                                            Trigger Hardcoded Sequence
                                        </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- GPIO Control Matrix -->
                <div
                    class="bg-white dark:bg-[#1e293b] rounded-2xl border border-slate-300 dark:border-slate-700/50 p-6 shadow-sm min-h-[400px]">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                                <div class="w-2 h-6 bg-emerald-500 rounded-full"></div>
                                GPIO Control Matrix
                            </h3>
                            <p class="text-xs text-slate-500 mt-1 sm:ml-5">Real-time hardware pin manipulation</p>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button @click="toggleGPIO('ALL_ON')" :disabled="runningSequence || !connected"
                                class="flex-1 sm:flex-none px-6 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition-all active:scale-95 disabled:opacity-30">
                                ALL ON</button>
                            <button @click="toggleGPIO('ALL_OFF')" :disabled="runningSequence || !connected"
                                class="flex-1 sm:flex-none px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg transition-all active:scale-95 disabled:opacity-30">
                                ALL OFF</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="gpio in gpios" :key="gpio.pin_number">
                            <div x-data="{ mode: 'timer', timerDuration: 5 }"
                                class="bg-slate-50 dark:bg-[#0f172a] rounded-xl p-5 border border-slate-300 dark:border-slate-700/50 relative overflow-hidden group flex flex-col justify-between min-h-[220px]">

                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors shadow-inner"
                                            :class="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'bg-emerald-500/20 text-emerald-500 dark:text-emerald-400' : 'bg-slate-200 dark:bg-slate-800 text-slate-500'">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-bold text-slate-800 dark:text-white text-base truncate"
                                                x-text="gpio.label || 'GPIO ' + gpio.pin_number" :title="gpio.label">
                                            </h4>
                                            <p class="text-[10px] text-slate-500 font-mono">PIN <span
                                                    x-text="gpio.pin_number"></span></p>
                                        </div>
                                    </div>
                                    <div class="w-3 h-3 rounded-full shadow-[0_0_8px_currentColor] transition-all duration-300"
                                        :class="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'bg-emerald-400 text-emerald-400' : 'bg-slate-700 text-slate-700'">
                                    </div>
                                </div>

                                <div
                                    class="bg-slate-200 dark:bg-slate-800 p-1 rounded-lg flex text-[10px] font-bold mb-4">
                                    <button @click="mode = 'manual'"
                                        :class="mode === 'manual' ? 'bg-white dark:bg-slate-600 text-slate-800 dark:text-white shadow' : 'text-slate-500 dark:text-slate-400'"
                                        class="flex-1 py-1 rounded transition-all">MANUAL</button>
                                    <button @click="mode = 'timer'"
                                        :class="mode === 'timer' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 dark:text-slate-400'"
                                        class="flex-1 py-1 rounded transition-all">TIMER</button>
                                </div>

                                <div>
                                    <div x-show="mode === 'manual'"
                                        class="flex items-center justify-between bg-slate-100 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-300 dark:border-slate-700/50">
                                        <span
                                            class="text-xs text-slate-500 font-medium font-mono text-[10px] uppercase tracking-tighter">Current:
                                            <span
                                                x-text="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'ON' : 'OFF'"
                                                :class="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'text-emerald-500' : 'text-slate-500'"></span></span>
                                        <button @click="toggleGPIO(gpio.pin_number)"
                                            :disabled="runningSequence || !connected"
                                            class="w-12 h-6 rounded-full p-1 transition-colors duration-300 focus:outline-none relative"
                                            :class="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'bg-emerald-500' : 'bg-slate-600'">
                                            <div class="w-4 h-4 rounded-full bg-white shadow-md transform transition-transform duration-300"
                                                :class="(gpio.is_active_low ? !gpio.is_active : gpio.is_active) ? 'translate-x-6' : 'translate-x-0'">
                                            </div>
                                        </button>
                                    </div>
                                    <div x-show="mode === 'timer'" class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <input type="number" x-model="timerDuration" min="1" max="60"
                                                class="w-16 bg-white dark:bg-slate-800 text-slate-800 dark:text-white text-center text-sm rounded border border-slate-300 dark:border-slate-600 py-1">
                                            <span class="text-xs text-slate-400">sec</span>
                                        </div>
                                        <button @click="pulseGPIO(gpio.pin_number, timerDuration)"
                                            :disabled="runningSequence || !connected"
                                            class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-bold shadow-lg transition-all flex items-center justify-center gap-2">PULSE
                                            ON</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Remote Serial Console -->
                <div
                    class="bg-white dark:bg-[#0f172a] rounded-2xl border border-slate-300 dark:border-slate-700/50 overflow-hidden shadow-2xl">
                    <div class="px-6 py-4 border-b border-white/5 bg-slate-900/50 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="p-1.5 bg-indigo-500/10 rounded-lg">
                                <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="font-bold text-sm text-slate-800 dark:text-slate-200 uppercase tracking-widest">
                                Remote Serial Console</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="machineLogs = []"
                                class="text-[10px] font-bold text-slate-500 hover:text-red-400 px-2 py-1 uppercase tracking-tighter">Clear</button>
                            <button @click="showLogs = !showLogs"
                                class="text-slate-500 hover:text-white transition-colors">
                                <svg class="w-4 h-4 transform transition-transform"
                                    :class="showLogs ? 'rotate-180' : ''" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div x-show="showLogs"
                        class="p-4 font-mono text-[11px] leading-relaxed max-h-[300px] overflow-y-auto bg-black/40 custom-scrollbar">
                        <template x-if="machineLogs.length === 0">
                            <div class="flex flex-col items-center justify-center py-10 text-slate-600 italic">
                                <svg class="w-8 h-8 mb-2 opacity-20" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>No activity logs received yet...</span>
                            </div>
                        </template>

                        <div class="flex flex-col gap-1">
                            <template x-for="(log, idx) in machineLogs" :key="idx">
                                <div
                                    class="group flex gap-3 hover:bg-white/5 p-1 rounded transition-colors border-l-2 border-transparent hover:border-indigo-500/50">
                                    <span class="text-slate-400 dark:text-slate-600 whitespace-nowrap"
                                        x-text="log.time"></span>
                                    <span
                                        class="text-indigo-500 dark:text-indigo-400/80 font-bold whitespace-nowrap">[SYS]</span>
                                    <span class="text-slate-600 dark:text-slate-300 break-all" :class="{
                                        'text-emerald-500 dark:text-emerald-400': log.message.includes('ON') || log.message.includes('Success'),
                                        'text-red-500 dark:text-red-400': log.message.includes('OFF') || log.message.includes('STOP') || log.message.includes('Error'),
                                        'text-amber-500 dark:text-amber-400': log.message.includes('Config') || log.message.includes('Heartbeat')
                                    }" x-text="log.message"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals (Re-using existing logic with updated styling) -->
        <!-- GPIO Configuration Modal -->
        <div x-show="gpioModalOpen" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
            <!-- Fixed Backdrop -->
            <div x-show="gpioModalOpen" x-transition.opacity class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px]"
                @click="gpioModalOpen = false"></div>

            <div class="flex items-center justify-center min-h-screen p-4">
                <!-- Modal Box -->
                <div @click.away="gpioModalOpen = false"
                    class="relative z-10 bg-white dark:bg-[#1e293b] rounded-2xl shadow-2xl border border-slate-300 dark:border-slate-700 w-full max-w-md overflow-hidden transform transition-all">
                    <div
                        class="px-6 py-4 border-b border-slate-300 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-[#0f172a]">
                        <h3 class="text-lg font-bold text-white uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                                </path>
                            </svg>
                            Hardware Configuration
                        </h3>
                        <button @click="gpioModalOpen = false" class="text-slate-400 hover:text-white p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                        <template x-for="(g, index) in editedGpios" :key="index">
                            <div
                                class="bg-slate-50 dark:bg-[#0f172a]/50 p-4 rounded-xl border border-slate-300 dark:border-slate-700/50 hover:border-indigo-500/30 transition-all group">
                                <div class="flex gap-4 items-start">
                                    <div class="flex-1 space-y-1" x-data="{ manualMode: false }">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-tighter">I/O
                                                Pin</label>
                                            <button @click="manualMode = !manualMode; if(!manualMode) g.pin_number = ''"
                                                class="text-[9px] text-indigo-400 font-bold uppercase hover:text-indigo-300 transition-colors"
                                                x-text="manualMode ? 'List' : 'Manual'"></button>
                                        </div>


                                        <select x-show="!manualMode" x-model.number="g.pin_number"
                                            class="w-full bg-white dark:bg-[#0f172a] border border-slate-300 dark:border-slate-700/50 rounded-lg px-2 py-1.5 text-slate-800 dark:text-white text-xs font-bold focus:border-indigo-500 outline-none appearance-none transition-all">
                                            <option value="" disabled>Select Pin...
                                            </option>
                                            <template x-for="p in [4,5,16,17,18,19,21,22,23,25,26,27,32,33]">
                                                <option :value="p" x-text="'GPIO ' + p">
                                                </option>
                                            </template>
                                        </select>

                                        <!-- Manual Input Mode -->
                                        <input x-show="manualMode" type="number" x-model.number="g.pin_number"
                                            placeholder="Enter ID"
                                            class="w-full bg-white dark:bg-[#0f172a] border border-slate-300 dark:border-slate-700/50 rounded-lg px-2 py-1.5 text-slate-800 dark:text-white text-xs font-bold focus:border-indigo-500 outline-none placeholder-slate-400 transition-all">
                                    </div>
                                    <div class="flex-[1.5] space-y-1">
                                        <label
                                            class="text-[9px] text-slate-500 uppercase font-black tracking-tighter">Alias
                                            / Label</label>
                                        <input type="text" x-model="g.label" placeholder="e.g. Pump 1"
                                            class="w-full bg-white dark:bg-[#0f172a] border border-slate-300 dark:border-slate-700/50 rounded-lg px-2 py-1.5 text-slate-800 dark:text-white text-xs font-bold focus:border-emerald-500 outline-none placeholder-slate-400 transition-all">
                                    </div>
                                    <div class="flex flex-col items-center gap-1.5">
                                        <label
                                            class="text-[9px] text-slate-500 uppercase font-black tracking-tighter">Invert</label>
                                        <button @click="g.is_active_low = !g.is_active_low"
                                            class="w-8 h-4 rounded-full relative transition-colors duration-200"
                                            :class="g.is_active_low ? 'bg-indigo-600' : 'bg-slate-700'">
                                            <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-transform duration-200"
                                                :class="g.is_active_low ? 'translate-x-4' : 'translate-x-0'">
                                            </div>
                                        </button>
                                    </div>


                                    <button @click="editedGpios.splice(index, 1)"
                                        class="pt-5 text-red-500/50 hover:text-red-500 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <button @click="editedGpios.push({ pin_number: '', label: '', is_active_low: true })"
                            class="w-full py-2 bg-indigo-600/10 border border-dashed border-indigo-500/30 hover:bg-indigo-600/20 text-indigo-400 hover:text-indigo-300 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4">
                                </path>
                            </svg>
                            REGISTER NEW PIN
                        </button>
                    </div>
                    <div
                        class="px-6 py-4 bg-slate-50 dark:bg-[#0f172a] border-t border-slate-300 dark:border-slate-700/50 flex gap-4">
                        <button @click="gpioModalOpen = false"
                            class="flex-1 py-2 text-xs font-black text-slate-500 uppercase tracking-widest hover:text-white transition-colors">Dismiss</button>
                        <button @click="saveGPIOConfig()"
                            class="flex-[2] py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-black uppercase tracking-widest shadow-lg shadow-indigo-600/20 active:scale-95 transition-all">
                            Commit Hardware Configuration
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sequence Editor Modal -->
            <div x-show="sequenceModalOpen" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
                <!-- Fixed Backdrop -->
                <div x-show="sequenceModalOpen" x-transition.opacity
                    class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px]" @click="sequenceModalOpen = false"></div>

                <div class="flex items-center justify-center min-h-screen p-4">
                    <!-- Modal Box -->
                    <div @click.away="sequenceModalOpen = false"
                        class="relative z-10 bg-white dark:bg-[#1e293b] rounded-2xl shadow-2xl border border-slate-300 dark:border-slate-700 w-full max-w-2xl overflow-hidden">
                        <div
                            class="px-6 py-4 border-b border-slate-300 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-[#0f172a]">
                            <h3 class="text-lg font-bold text-white">Edit Sequences</h3>
                            <button @click="sequenceModalOpen = false" class="text-slate-400 hover:text-white"><svg
                                    class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12">
                                    </path>
                                </svg></button>
                        </div>
                        <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                            <template x-for="(s, index) in editedSequences" :key="index">
                                <div draggable="true" @dragstart="draggingIndex = index" @dragover.prevent
                                    @drop="if(draggingIndex !== null) { const item = editedSequences.splice(draggingIndex, 1)[0]; editedSequences.splice(index, 0, item); draggingIndex = null; }"
                                    class="bg-slate-50 dark:bg-[#0f172a]/50 p-4 rounded-xl border border-slate-300 dark:border-slate-700/50 space-y-3 cursor-move transition-all duration-200"
                                    :class="{ 'opacity-50 border-dashed border-indigo-500': draggingIndex === index, 'hover:border-slate-300 dark:hover:border-slate-500': draggingIndex === null }">

                                    <div class="flex justify-between items-center border-b border-slate-800/50 pb-3">
                                        <div class="flex items-center gap-3">
                                            <!-- Drag Handle -->
                                            <div class="p-1 hover:bg-white/5 rounded transition-colors">
                                                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M4 8h16M4 16h16"></path>
                                                </svg>
                                            </div>

                                            <div class="bg-indigo-600/20 text-indigo-400 w-7 h-7 rounded-lg flex items-center justify-center text-[10px] font-black border border-indigo-500/30"
                                                x-text="index + 1"></div>

                                            <input type="text" x-model="s.description"
                                                placeholder="Action Label (e.g. Tank Fill)"
                                                class="bg-transparent border-none outline-none text-slate-800 dark:text-white font-bold text-xs placeholder-slate-400 dark:placeholder-slate-700 w-full focus:placeholder-slate-600 dark:focus:placeholder-slate-500 transition-all">
                                        </div>
                                        <button @click="editedSequences.splice(index, 1)"
                                            class="text-red-500/40 hover:text-red-500 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="grid grid-cols-3 gap-4">
                                        <div class="space-y-1">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-tighter ml-1">Pin
                                                Assignment</label>
                                            <select x-model.number="s.pin_number"
                                                class="w-full bg-[#0f172a] border border-slate-700/50 rounded-lg px-2 py-1.5 text-white text-xs font-bold outline-none focus:border-indigo-500 transition-all">
                                                <option value="-1" class="font-bold text-indigo-400">★ ALL
                                                    PINS (GLOBAL)
                                                </option>
                                                <option disabled>──────────</option>
                                                <template x-for="g in gpios" :key="g.pin_number">
                                                    <option :value="g.pin_number"
                                                        x-text="'Pin ' + g.pin_number + ' (' + g.label + ')'">
                                                    </option>
                                                </template>
                                            </select>
                                        </div>

                                        <div class="space-y-1">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-tighter ml-1">Logic
                                                State</label>
                                            <div
                                                class="flex bg-[#0f172a] rounded-lg p-0.5 border border-slate-700/50 h-[30px]">
                                                <button @click="s.action = 'ON'"
                                                    class="flex-1 text-[10px] font-black rounded transition-all"
                                                    :class="s.action === 'ON' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'">ON</button>
                                                <button @click="s.action = 'OFF'"
                                                    class="flex-1 text-[10px] font-black rounded transition-all"
                                                    :class="s.action === 'OFF' ? 'bg-red-500 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'">OFF</button>
                                            </div>
                                        </div>

                                        <div class="space-y-1">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-tighter ml-1">Duration
                                                (MS)</label>
                                            <input type="number" x-model.number="s.duration_ms" step="500"
                                                placeholder="1000"
                                                class="w-full bg-white dark:bg-[#0f172a] border border-slate-300 dark:border-slate-700/50 rounded-lg px-2 py-1.5 text-slate-800 dark:text-white text-xs font-bold outline-none focus:border-amber-500 transition-all">
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <button
                                @click="editedSequences.push({ pin_number: gpios[0]?.pin_number || 4, action: 'ON', duration_ms: 1000, step_index: editedSequences.length + 1 })"
                                class="w-full py-2 bg-emerald-500/10 border border-dashed border-emerald-500/30 hover:bg-emerald-500/20 text-emerald-400 hover:text-emerald-300 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6">
                                    </path>
                                </svg>
                                APPEND NEW STEP
                            </button>
                        </div>

                        <div
                            class="px-6 py-4 bg-slate-50 dark:bg-[#0f172a] border-t border-slate-300 dark:border-slate-700/50 flex gap-4">
                            <button @click="sequenceModalOpen = false"
                                class="flex-1 py-2 text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest hover:text-slate-800 dark:hover:text-white transition-colors">Discard</button>
                            <button @click="saveSequenceConfig()"
                                class="flex-[2] py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-xs font-black uppercase tracking-widest shadow-lg shadow-emerald-600/20 active:scale-95 transition-all">
                                Save Execution Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OTA Firmware Update Modal -->
                <div x-show="otaModalOpen" class="fixed inset-0 z-[80] overflow-y-auto" x-cloak>
                    <!-- Enhanced Dark Backdrop -->
                    <div x-show="otaModalOpen" x-transition.opacity
                        class="fixed inset-0 bg-slate-950/60 backdrop-blur-[4px]"
                        @click="!uploadingOTA && (otaModalOpen = false)"></div>

                    <div class="flex items-center justify-center min-h-screen p-4">
                        <!-- Premium Modal Box (Matching Payment QR Look) -->
                        <div x-show="otaModalOpen" x-transition:enter="transition ease-out duration-300"
                            x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                            x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                            @click.away="!uploadingOTA && (otaModalOpen = false)"
                            class="relative z-10 bg-[#111827] rounded-[3rem] shadow-2xl border border-slate-800 w-full max-w-lg overflow-hidden p-8">

                            <!-- Header -->
                            <div class="flex justify-between items-center mb-8">
                                <h3
                                    class="text-2xl font-black text-white items-center flex gap-4 uppercase tracking-tight">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                        </svg>
                                    </div>
                                    Firmware Update (OTA)
                                </h3>
                                <button @click="otaModalOpen = false" x-show="!uploadingOTA"
                                    class="p-3 bg-slate-800/50 text-slate-400 hover:text-white rounded-full transition-colors border border-slate-700/50">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-8">
                                <!-- Info Section -->
                                <div class="text-center px-4">
                                    <div
                                        class="w-20 h-20 bg-indigo-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-sm text-slate-400 leading-relaxed font-medium">
                                        Remote update allows you to modify the machine's behavior by uploading a new
                                        <span
                                            class="bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded font-bold">.bin</span>
                                        firmware file directly.
                                    </p>
                                </div>

                                <!-- File Selection Area -->
                                <div class="relative group">
                                    <input type="file" id="otaInput" accept=".bin" class="hidden"
                                        @change="otaFile = $event.target.files[0]">
                                    <label for="otaInput"
                                        class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-800 rounded-[2rem] cursor-pointer bg-slate-900/30 hover:bg-slate-900/50 hover:border-indigo-500/50 transition-all group overflow-hidden">
                                        <template x-if="!otaFile">
                                            <div class="flex flex-col items-center justify-center text-center">
                                                <svg class="w-12 h-12 mb-4 text-slate-600 group-hover:text-indigo-400 transition-colors"
                                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2.5"
                                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12">
                                                    </path>
                                                </svg>
                                                <p class="text-xs font-black text-slate-500 uppercase tracking-widest">
                                                    Select Binary File</p>
                                                <p
                                                    class="text-[9px] text-slate-700 mt-2 uppercase font-bold tracking-tighter">
                                                    Click or Drag & Drop</p>
                                            </div>
                                        </template>
                                        <template x-if="otaFile">
                                            <div
                                                class="flex flex-col items-center justify-center p-6 w-full h-full bg-emerald-500/5">
                                                <div
                                                    class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400 mb-4">
                                                    <svg class="w-6 h-6" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="3" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                </div>
                                                <p class="text-sm font-black text-white truncate max-w-full px-4 text-center"
                                                    x-text="otaFile.name"></p>
                                                <p class="text-[10px] text-emerald-400 mt-2 font-black uppercase tracking-widest"
                                                    x-text="(otaFile.size / 1024).toFixed(1) + ' KB'"></p>
                                                <button @click.prevent.stop="otaFile = null"
                                                    class="mt-4 text-[10px] text-red-400 hover:text-red-300 font-black uppercase tracking-widest underline decoration-2 underline-offset-4">Remove
                                                    File</button>
                                            </div>
                                        </template>
                                    </label>
                                </div>

                                <!-- Progress Bar (Animated) -->
                                <div x-show="uploadingOTA" x-transition class="space-y-3">
                                    <div
                                        class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden relative shadow-inner">
                                        <div
                                            class="bg-indigo-500 h-full absolute top-0 left-0 animate-progress-indefinite shadow-[0_0_15px_rgba(99,102,241,0.6)]">
                                        </div>
                                    </div>
                                    <div
                                        class="flex justify-between items-center text-[10px] uppercase font-black tracking-widest">
                                        <span class="text-indigo-400 animate-pulse">Transferring Firmware...</span>
                                        <span class="text-slate-600">Do not close window</span>
                                    </div>
                                </div>

                                <!-- Action Button -->
                                <!-- Action Button -->
                                <div class="space-y-3">
                                    <button @click="uploadFirmware()" :disabled="!otaFile || uploadingOTA"
                                        class="w-full py-5 bg-[#5b4eff] hover:bg-[#4a3fcc] disabled:opacity-20 disabled:grayscale text-white rounded-[1.5rem] font-black text-xs uppercase tracking-[0.2em] shadow-[0_10px_30px_rgba(91,78,255,0.3)] transition-all flex items-center justify-center gap-3 active:scale-[0.98] group relative overflow-hidden">

                                        <!-- Ripple Effect Container -->
                                        <div
                                            class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                        </div>

                                        <template x-if="!uploadingOTA">
                                            <div class="flex items-center gap-3 relative z-10">
                                                <svg class="w-5 h-5 group-hover:-translate-y-1 transition-transform"
                                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2.5"
                                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12">
                                                    </path>
                                                </svg>
                                                <span>Push Update to Machine</span>
                                            </div>
                                        </template>
                                        <template x-if="uploadingOTA">
                                            <div class="flex items-center gap-3 relative z-10">
                                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                                    fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10"
                                                        stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor"
                                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                    </path>
                                                </svg>
                                                <span>Deploying System...</span>
                                            </div>
                                        </template>
                                    </button>

                                    <!-- Status Bar for Debugging -->
                                    <div
                                        class="flex justify-between items-center px-4 py-3 bg-slate-900/50 rounded-xl border border-slate-800/50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full transition-colors duration-500"
                                                :class="connected ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-red-500'">
                                            </div>
                                            <span
                                                class="text-[9px] font-black uppercase tracking-widest text-slate-500">Machine
                                                Link</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full transition-colors duration-300"
                                                :class="otaFile ? 'bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]' : 'bg-slate-700'">
                                            </div>
                                            <span
                                                class="text-[9px] font-black uppercase tracking-widest text-slate-500">Firmware
                                                File</span>
                                        </div>
                                    </div>

                                    <!-- Dynamic Help Text -->
                                    <div x-show="!otaFile || !connected" class="text-center h-4">
                                        <p
                                            class="text-[9px] text-orange-400 font-bold uppercase tracking-wide animate-pulse">
                                            <span x-show="!connected">⚠ Waiting for Machine Connection...</span>
                                            <span x-show="connected && !otaFile">⚠ Please select a file to enable
                                                update</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment QR Modal -->
                    <div x-show="showQRModal" class="fixed inset-0 z-[70] overflow-y-auto" x-cloak>
                        <!-- Fixed Backdrop -->
                        <div x-show="showQRModal" x-transition.opacity
                            class="fixed inset-0 bg-slate-950/40 backdrop-blur-[2px]" @click="showQRModal = false">
                        </div>

                        <div class="flex items-center justify-center min-h-screen p-4">
                            <!-- Modal Box -->
                            <div @click.away="showQRModal = false" x-data="{ qrTab: 'actual' }"
                                class="relative z-10 bg-[#111827] rounded-[3rem] shadow-2xl border border-slate-800 w-full max-w-lg overflow-hidden transform transition-all p-8">

                                <div class="flex justify-between items-center mb-8">
                                    <h3
                                        class="text-2xl font-black text-white items-center flex gap-4 uppercase tracking-tight">
                                        <div
                                            class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                            </svg>
                                        </div>
                                        Payment Entry
                                    </h3>
                                    <button @click="showQRModal = false"
                                        class="p-3 bg-slate-800/50 text-slate-400 hover:text-white rounded-full transition-colors border border-slate-700/50">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Toggle -->
                                <div class="bg-[#1f2937]/50 p-1.5 rounded-2xl border border-slate-700/50 flex mb-8">
                                    <button @click="qrTab = 'actual'"
                                        :class="qrTab === 'actual' ? 'bg-[#5b4eff] text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'"
                                        class="flex-1 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-[0.2em] transition-all">
                                        Main QR
                                    </button>
                                    <button @click="qrTab = 'test'"
                                        :class="qrTab === 'test' ? 'bg-[#5b4eff] text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'"
                                        class="flex-1 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-[0.2em] transition-all">
                                        Testing QR
                                    </button>
                                </div>

                                <div
                                    class="relative aspect-square bg-[#1f2937]/30 rounded-[2rem] border border-slate-800/50 flex items-center justify-center p-10 overflow-hidden">
                                    <!-- Actual QR Content -->
                                    <div x-show="qrTab === 'actual'" x-transition
                                        class="w-full h-full flex flex-col items-center justify-center gap-6">
                                        <template x-if="actual_qr_url && actual_qr_url !== 'undefined'">
                                            <div class="contents">
                                                <img :src="actual_qr_url"
                                                    class="w-full h-full object-contain filter drop-shadow-2xl">
                                                <p
                                                    class="text-[10px] text-emerald-400 font-black uppercase tracking-[0.3em] animate-pulse">
                                                    Live Production</p>
                                            </div>
                                        </template>
                                        <template x-if="!actual_qr_url">
                                            <span
                                                class="text-slate-600 text-[10px] font-black uppercase italic tracking-widest">No
                                                Main
                                                QR Uploaded</span>
                                        </template>
                                    </div>

                                    <!-- Test QR Content -->
                                    <div x-show="qrTab === 'test'" x-transition
                                        class="w-full h-full flex flex-col items-center justify-center gap-6">
                                        <template x-if="test_qr_url">
                                            <div class="contents">
                                                <img :src="test_qr_url"
                                                    class="w-full h-full object-contain filter drop-shadow-2xl">
                                                <p
                                                    class="text-[10px] text-indigo-400 font-black uppercase tracking-[0.3em] animate-pulse">
                                                    Sandbox Testing</p>
                                            </div>
                                        </template>
                                        <template x-if="!test_qr_url">
                                            <span
                                                class="text-slate-600 text-[10px] font-black uppercase italic tracking-widest">No
                                                Test
                                                QR Uploaded</span>
                                        </template>
                                    </div>
                                </div>

                                <div class="mt-8 pt-8 border-t border-slate-800/50">
                                    <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">
                                        Change or Upload Codes
                                    </h4>
                                    <form :action="'/machines/update/' + id + '?_csrf=' + '<%= locals.csrfToken %>'"
                                        method="POST" enctype="multipart/form-data" class="space-y-4"
                                        x-data="{ syncing: false }" @submit="syncing = true">
                                        <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">

                                        <!-- Focused Upload Field -->
                                        <div x-show="qrTab === 'actual'" x-transition>
                                            <label
                                                class="text-[9px] font-black text-emerald-500 uppercase tracking-widest pl-2 mb-2 block">
                                                Upload Main QR
                                            </label>
                                            <input type="file" name="actual_qr" accept="image/*"
                                                class="block w-full text-[10px] text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-[9px] file:font-black file:uppercase file:bg-[#1f2937] file:text-emerald-400 hover:file:bg-slate-700 transition-all border border-slate-800/50 bg-slate-900/30 rounded-2xl">
                                        </div>

                                        <div x-show="qrTab === 'test'" x-transition>
                                            <label
                                                class="text-[9px] font-black text-indigo-500 uppercase tracking-widest pl-2 mb-2 block">
                                                Upload Testing QR
                                            </label>
                                            <input type="file" name="test_qr" accept="image/*"
                                                class="block w-full text-[10px] text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-[9px] file:font-black file:uppercase file:bg-[#1f2937] file:text-indigo-400 hover:file:bg-slate-700 transition-all border border-slate-800/50 bg-slate-900/30 rounded-2xl">
                                        </div>

                                        <button type="submit" :disabled="syncing"
                                            class="w-full mt-4 py-4 bg-[#5b4eff] text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-[#4a3fcc] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                            <template x-if="!syncing">
                                                <span>Sync Selected QR</span>
                                            </template>
                                            <template x-if="syncing">
                                                <div class="flex items-center gap-2">
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                        fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10"
                                                            stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor"
                                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                        </path>
                                                    </svg>
                                                    <span>Uploading...</span>
                                                </div>
                                            </template>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>

                    <script>

                        // Server-side data injection (via Base64) - ROBUST AGAINST FORMATTERS
                        const encodedData = '<%= frontendDataEncoded %>';
                        let serverData = {};
                        try {
                            if (encodedData) serverData = JSON.parse(atob(encodedData));
                        } catch (e) {
                            console.error('Failed to decode server data', e);
                            serverData = {};
                        }

                        // Robust Alpine Component Definition
                        document.addEventListener('alpine:init', () => {
                            Alpine.data('machineCtrl', () => ({
                                machine_id: serverData.machine_id || '',
                                machine_name: serverData.machine_name || '',
                                connected: !!serverData.connected,
                                runningSequence: !!serverData.runningSequence,
                                networkInfo: serverData.networkInfo || {},
                                gpios: serverData.gpios || [],
                                sequences: serverData.sequences || [],
                                primary_sequence_id: serverData.primary_sequence_id || 'DB_DEFAULT',
                                transactions: serverData.transactions || [],
                                machineLogs: serverData.recentLogs || [],
                                test_qr_url: serverData.test_qr_url,
                                actual_qr_url: serverData.actual_qr_url,
                                lastHeartbeat: '<%- machine.last_heartbeat ? new Date(machine.last_heartbeat).toLocaleString() : "Never" %>',

                                // Local State
                                pingMs: 0,
                                gpioModalOpen: false,
                                editedGpios: [],
                                sequenceModalOpen: false,
                                editedSequences: [],
                                currentStepDescription: null,
                                currentStepIndex: null,
                                draggingIndex: null,
                                socket: null,
                                otaModalOpen: false,
                                uploadingOTA: false,
                                otaFile: null,
                                showQRModal: false,
                                showLogs: true,


                                init() {
                                    console.log('Alpine Init - Machine ID:', this.machine_id);

                                    // FORCE CLOSE ALL MODALS ON INIT
                                    this.gpioModalOpen = false;
                                    this.sequenceModalOpen = false;
                                    this.otaModalOpen = false;
                                    this.showQRModal = false;

                                    // Wait for Socket.IO to be available
                                    const initSocket = () => {
                                        if (typeof io === 'undefined') {
                                            console.warn('Socket.IO not loaded yet, retrying...');
                                            setTimeout(initSocket, 50);
                                            return;
                                        }

                                        const socket = io({
                                            transports: ['websocket'],
                                            upgrade: false
                                        });
                                        this.socket = socket;

                                        socket.emit('register', JSON.stringify({
                                            machine_id: this.machine_id,
                                            client_type: 'web'
                                        }));

                                        // Start Ping Loop
                                        setInterval(() => {
                                            const start = Date.now();
                                            socket.emit('ping_req', start);
                                        }, 2000);

                                        socket.on('pong_res', (start) => {
                                            this.pingMs = Date.now() - start;
                                        });

                                        socket.on('machine_log', (data) => {
                                            this.machineLogs.unshift({
                                                ...data,
                                                time: new Date(data.received_at || Date.now()).toLocaleTimeString()
                                            });
                                            if (this.machineLogs.length > 50) this.machineLogs.pop();

                                            // Parse LOG for Step Updates (Requested: use esp32 log in that steps can be shown)
                                            // Pattern: 👉 Step 1: Description
                                            const stepMatch = data.message.match(/👉 Step (\d+): (.*)/);
                                            if (stepMatch) {
                                                this.currentStepIndex = parseInt(stepMatch[1]);
                                                this.currentStepDescription = stepMatch[2];
                                                if (!this.runningSequence) this.runningSequence = true;
                                            }
                                        });

                                        socket.on('machine_update', (data) => {
                                            if (data.machine_id === this.machine_id) {
                                                if (data.is_connected !== undefined) this.connected = data.is_connected;
                                                if (data.last_heartbeat) this.lastHeartbeat = new Date(data.last_heartbeat).toLocaleString();

                                                if (data.is_running_sequence === true && this.runningSequence === false) {
                                                    this.showToast('Sanitization Process Started');
                                                }

                                                if (data.new_transaction) {
                                                    this.transactions.unshift(data.new_transaction);
                                                    if (this.transactions.length > 5) this.transactions.pop();
                                                }

                                                if (data.is_running_sequence !== undefined) this.runningSequence = !!data.is_running_sequence;

                                                // Enhanced Step Tracking
                                                if (data.current_step) {
                                                    this.currentStepIndex = data.current_step;
                                                    // Try to find description in our local sequence list if server didn't send one
                                                    if (!data.step_description && this.sequences) {
                                                        const step = this.sequences.find(s => s.step_index == data.current_step);
                                                        this.currentStepDescription = step ? (step.description || step.action) : null;
                                                    } else {
                                                        this.currentStepDescription = data.step_description;
                                                    }
                                                } else if (this.runningSequence && this.sequences && this.sequences.length > 0) {
                                                    // FALLBACK: Infer step from active GPIOs if firmware doesn't send current_step
                                                    // We check which sequence step matches the currently active pin
                                                    // Note: This assumes sequence steps activate distinct pins or are ordered
                                                    const activePin = this.gpios.find(g => g.is_active)?.pin_number;
                                                    if (activePin) {
                                                        const step = this.sequences.find(s => s.pin_number == activePin && s.action === 'ON');
                                                        if (step) {
                                                            this.currentStepIndex = step.step_index;
                                                            this.currentStepDescription = step.description || step.action;
                                                        }
                                                    }
                                                } else if (!this.runningSequence) {
                                                    this.currentStepDescription = null;
                                                    this.currentStepIndex = null;
                                                }

                                                if (data.network) {
                                                    this.networkInfo = {
                                                        ssid: data.network.ssid || data.network.s,
                                                        rssi: data.network.rssi || data.network.r,
                                                        ip: data.network.ip || data.network.i
                                                    };
                                                }

                                                if (data.states && Array.isArray(this.gpios)) {
                                                    this.gpios.forEach(g => {
                                                        if (!g) return;
                                                        const val = data.states[g.pin_number];
                                                        if (val !== undefined) {
                                                            g.is_active = (val === true || val === 1 || val === '1');
                                                        }
                                                    });
                                                }

                                                if (data.is_running_sequence !== undefined) this.runningSequence = !!data.is_running_sequence;
                                            }
                                        });
                                    };

                                    // Start Socket.IO initialization
                                    initSocket();
                                },

                                showToast(message) {
                                    const toast = document.createElement('div');
                                    toast.className = 'fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 z-[100] animate-bounce';
                                    toast.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="font-bold">${message}</span>`;
                                    document.body.appendChild(toast);
                                    setTimeout(() => toast.remove(), 5000);
                                },

                                async toggleGPIO(pinOrAction) {
                                    // OPTIMISTIC UPDATE: Immediate visual feedback
                                    let targetGpio = null;
                                    let previousState = null;

                                    if (typeof pinOrAction !== 'string') {
                                        // It's a pin number
                                        targetGpio = this.gpios.find(g => g.pin_number === pinOrAction);
                                        if (targetGpio) {
                                            previousState = targetGpio.is_active;
                                            // Immediately flip state visually
                                            targetGpio.is_active = !targetGpio.is_active;
                                        }
                                    } else if (pinOrAction === 'ALL_ON') {
                                        // Turn all on visually
                                        this.gpios.forEach(g => g.is_active = true);
                                    } else if (pinOrAction === 'ALL_OFF') {
                                        // Turn all off visually
                                        this.gpios.forEach(g => g.is_active = false);
                                    }

                                    try {
                                        const payload = typeof pinOrAction === 'string'
                                            ? { action: pinOrAction }
                                            : { pin: pinOrAction };

                                        const response = await fetch(`/machines/control/${this.machine_id}/toggle`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify(payload)
                                        });
                                        const result = await response.json();

                                        if (!result.success) {
                                            // REVERT ON FAILURE
                                            if (targetGpio) targetGpio.is_active = previousState;
                                            alert('Command failed: ' + (result.error || 'Check connection'));
                                        } else {
                                            if (typeof pinOrAction === 'string') {
                                                this.showToast(pinOrAction === 'ALL_ON' ? 'All Pins Activated' : 'All Pins Deactivated');
                                            }
                                        }
                                    } catch (err) {
                                        console.error(err);
                                        // REVERT ON ERROR
                                        if (targetGpio) targetGpio.is_active = previousState;
                                    }
                                },

                                async pulseGPIO(pin, duration) {
                                    try {
                                        // duration is in seconds from input, convert to ms
                                        const durationMs = duration * 1000;
                                        const response = await fetch(`/machines/control/${this.machine_id}/pulse`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify({ pin, duration: durationMs })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            this.showToast(`Pulsing Pin ${pin} for ${duration}s`);
                                        } else {
                                            alert('Failed to pulse GPIO');
                                        }
                                    } catch (err) { console.error(err); }
                                },

                                async runSequence(sequenceId = null) {
                                    if (!this.connected || this.runningSequence) return;
                                    try {
                                        const response = await fetch(`/machines/control/${this.machine_id}/sequence`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify({ sequence_id: sequenceId || this.primary_sequence_id || 'DB_DEFAULT' })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            this.runningSequence = true;
                                            this.showToast(sequenceId ? `Local Sequence ${sequenceId} Started` : 'Primary Sequence Started');
                                        }
                                    } catch (err) { console.error(err); }
                                },

                                async setPrimarySequence(id) {
                                    if (!confirm(`Set "${id}" as the Primary Sequence for payments?`)) return;
                                    try {
                                        const response = await fetch(`/machines/control/${this.machine_id}/update-primary`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify({ primary_sequence_id: id })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            this.primary_sequence_id = id;
                                            this.showToast(`Primary Sequence updated to: ${id}`);
                                        } else {
                                            alert('Failed to update primary sequence');
                                        }
                                    } catch (err) { console.error(err); }
                                },

                                async emergencyStop() {
                                    if (!confirm('EMERGENCY STOP: Are you sure?')) return;
                                    try {
                                        const response = await fetch(`/machines/control/${this.machine_id}/emergency-stop`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' }
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            this.runningSequence = false;
                                            alert('Emergency Stop Command Sent');
                                        }
                                    } catch (err) { console.error(err); }
                                },

                                async reconnectWifi() {
                                    console.log('reconnectWifi called');
                                    if (!confirm('Request WiFi Reconnection?')) return;
                                    try {
                                        console.log('Sending request...');
                                        const response = await fetch(`/machines/control/${this.machine_id}/reconnect-wifi`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' }
                                        });
                                        const result = await response.json();
                                        console.log('Result:', result);
                                        if (result.success) alert('Reconnection command sent');
                                        else alert('Failed: ' + result.error);
                                    } catch (err) {
                                        console.error('Reconnect Error:', err);
                                        alert('Error sending command: ' + err.message);
                                    }
                                },

                                openConfigModal() {
                                    this.editedGpios = JSON.parse(JSON.stringify(this.gpios));
                                    this.gpioModalOpen = true;
                                },

                                async saveGPIOConfig() {
                                    try {
                                        const response = await fetch(`/machines/control/${this.machine_id}/config`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify({ gpios: this.editedGpios })
                                        });
                                        const result = await response.json();
                                        // Reload to reflect changes
                                        location.reload();
                                    } catch (err) { console.error(err); }
                                },

                                openSequenceModal() {
                                    this.editedSequences = JSON.parse(JSON.stringify(this.sequences)).map(s => {
                                        // Map Backend Global Actions to Frontend UI (Pin -1)
                                        if (s.action === 'ALL_ON') return { ...s, pin_number: -1, action: 'ON' };
                                        if (s.action === 'ALL_OFF') return { ...s, pin_number: -1, action: 'OFF' };

                                        // Fix for Potential DB Corruption/Legacy Data (null pin but not ALL_ON/OFF)
                                        if (s.pin_number === null) {
                                            return { ...s, pin_number: -1, action: s.action || 'ON' };
                                        }

                                        return s;
                                    });
                                    this.sequenceModalOpen = true;
                                },

                                async saveSequenceConfig() {
                                    // 1. Prepare Payload (Map Frontend -1 back to Backend Global Actions)
                                    const payload = this.editedSequences.map(s => {
                                        if (s.pin_number === -1) {
                                            return {
                                                ...s,
                                                pin_number: null,
                                                action: s.action === 'ON' ? 'ALL_ON' : 'ALL_OFF'
                                            };
                                        }
                                        return s;
                                    });

                                    // 2. Validation
                                    const invalidStep = payload.find(s =>
                                        !['ALL_ON', 'ALL_OFF'].includes(s.action) &&
                                        !s.pin_number && s.pin_number !== 0
                                    );

                                    if (invalidStep) {
                                        alert('Please select a valid pin for all standard steps.');
                                        return;
                                    }

                                    try {
                                        const response = await fetch(`/machines/control/${this.machine_id}/sequence/update`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= locals.csrfToken %>' },
                                            body: JSON.stringify({ sequences: payload })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            location.reload();
                                        } else {
                                            alert('Failed to save sequence: ' + (result.error || 'Unknown error'));
                                        }
                                    } catch (err) {
                                        console.error(err);
                                        alert('Network error saving sequence');
                                    }
                                },

                                async uploadFirmware() {
                                    if (!this.otaFile) return alert('Please select a .bin firmware file first.');
                                    if (!this.connected) return alert('Machine must be ONLINE to receive updates.');

                                    if (!confirm('CRITICAL: Applying new firmware will restart the machine and interrupt all active services. Proceed?')) return;

                                    this.uploadingOTA = true;
                                    const formData = new FormData();
                                    formData.append('firmware', this.otaFile);

                                    try {
                                        console.log('[OTA] Starting upload to server...');
                                        const response = await fetch(`/machines/control/${this.machine_id}/ota`, {
                                            method: 'POST',
                                            headers: {
                                                'X-CSRF-Token': '<%= locals.csrfToken %>'
                                            },
                                            body: formData
                                        });

                                        const result = await response.json();
                                        if (result.success) {
                                            console.log('[OTA] Upload success, command sent.');
                                            this.showToast('Firmware Deployed! Machine is now updating...');
                                            setTimeout(() => {
                                                this.otaModalOpen = false;
                                                this.otaFile = null;
                                                this.uploadingOTA = false;
                                            }, 2000);
                                        } else {
                                            console.error('[OTA] Server error:', result);
                                            alert(result.error || 'Failed to dispatch firmware command. Check logs.');
                                        }
                                    } catch (err) {
                                        console.error('[OTA] Request failed:', err);
                                        alert('Network error: Could not reach server. Verify your internet connection.');
                                    } finally {
                                        this.uploadingOTA = false;
                                    }
                                }
                            }));
                        });
                    </script>

                    <%- include('../partials/footer') %>